#!/bin/bash

function banner() {
cat << "EOF"
 _____           _   _____ _             _           _        _ _           
|_   _|         | | /  ___(_)           (_)         | |      | | |          
  | | _ __   ___| |_\ `--. _ _ __ ___    _ _ __  ___| |_ __ _| | | ___ _ __ 
  | || '_ \ / _ \ __|`--. \ | '_ ` _ \  | | '_ \/ __| __/ _` | | |/ _ \ '__|
 _| || | | |  __/ |_/\__/ / | | | | | | | | | | \__ \ || (_| | | |  __/ |   
 \___/_| |_|\___|\__\____/|_|_| |_| |_| |_|_| |_|___/\__\__,_|_|_|\___|_|   
         _____  __              ___   _                        _  ____      
        |  _  |/  |            / / | | |                      | |/ _\ \     
__   __ | |/' |`| |   ______  | || |_| |__   _____      _____ | | |_ | |    
\ \ / / |  /| | | |  |______| | || __| '_ \ / _ \ \ /\ / / _ \| |  _|| |    
 \ V /  \ |_/ /_| |_          | || |_| | | |  __/\ V  V / (_) | | |  | |    
  \_/    \___(_)___/          | | \__|_| |_|\___| \_/\_/ \___/|_|_|  | |    
                               \_\                                  /_/     
                                                                            
EOF
}

function checkAdmin() {
	if [ "$EUID" -ne 0 ]
	then
		echo "[!] Need to be root"
		exit 1
	fi
}

function updateAll() {
	printf "[*] Updating system...\n"
	(apt-get update && apt-get upgrade) > /dev/null 2>&1
	if [ $? -eq 0 ]
	then
		printf "[+] Updated successfully!\n\n"
	else
		printf "[!] Error updating\n\n"
		exit 2
	fi
}

function installDepend() {
	printf "[*] Installing dependencies...\n"
	(apt-get install -y curl open-vm-tools wget nmap) > /dev/null 2>&1
	if [ $? -eq 0 ]
	then
		printf "[+] Dependencies installed successfully!\n\n"
	else
		printf "[!] Error installing deps\n\n"
		exit 3
	fi
}

function installInetSim() {
	printf "[*] Installing InetSim...\n"
	(echo "deb http://www.inetsim.org/debian/ binary/" > /etc/apt/sources.list.d/inetsim.list && \
	wget -O - http://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add - && \
	apt-get update && \
	apt-get install -y inetsim) > /dev/null 2>&1
	if [ $? -eq 0 ]
	then
		printf "[+] InetSim installed successfully!\n\n"
	else
		printf "[!] Error installing InetSim\n\n"
		exit 4
	fi
}

function configRc() {
	printf "[*] Enabling rc.local...\n"
	(touch /etc/rc.local && \
	chmod +x /etc/rc.local && \
	systemctl enable rc-local) > /dev/null 2>&1
	if [ $? -eq 0 ]
	then
		printf "[+] Rc.local enabled successfully!\n\n"
	else
		printf "[!] Error enabling rc.local\n\n"
		exit 5
	fi

	printf "[*] Configuring rc.local...\n"

	echo '' > /etc/rc.local
	echo '#!/bin/bash' > /etc/rc.local
	echo 'inetsim --bind-address 0.0.0.0 --session $(date +%Y-%m-%d--%H_%M) > /dev/null' >> /etc/rc.local
	echo 'exit 0' >> /etc/rc.local

	if [ $? -eq 0 ]
	then
		printf "[+] Rc.local configured successfully!\n\n"
	else
		printf "[!] Error configuring rc.local\n\n"
		exit 6
	fi
}

function main() {
	banner
	checkAdmin
	updateAll
	installDepend
	installInetSim
	configRc
	printf "[!!] We need to restart the system!\n"
	read -p '[x] Do you want to reboot now? (yes|no): ' option
	if [ "$option" = "yes" ] || [ "$option" = "y" ]
	then
		shutdown -r now
	fi
	exit 0
}

main
